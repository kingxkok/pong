<html>
  <head>
    <meta charset="utf-8">
      <title>PONG</title>
    </head>
  <body>
    <center>
      <canvas id='screen' width='1024' height='720'></canvas>
    </center>
    <audio id='BGM' controls autoplay style='display:none'>
        <source src='BGM/PON_PON_PON.mp3' type='audio/mpeg' loop=true>
        Your browser does not support this tag.
    </audio>
    <audio id='BWG' controls style='display:none'>
        <source src='SoundEffect/BWG.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='BWR' controls style='display:none'>
        <source src='SoundEffect/BWR.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='RWG' controls style='display:none'>
        <source src='SoundEffect/RWG.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='RWR' controls style='display:none'>
        <source src='SoundEffect/RWR.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='TU' controls style='display:none'>
        <source src='SoundEffect/TU.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='T' controls style='display:none'>
        <source src='SoundEffect/T.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='GS' controls style='display:none'>
        <source src='SoundEffect/GS.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='GP' controls style='display:none'>
        <source src='SoundEffect/GP.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='GR' controls style='display:none'>
        <source src='SoundEffect/GR.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='BA' controls style='display:none'>
        <source src='SoundEffect/BA.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='BR' controls style='display:none'>
        <source src='SoundEffect/BR.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='BMP' controls style='display:none'>
        <source src='SoundEffect/BMP.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='BMR' controls style='display:none'>
        <source src='SoundEffect/BMR.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='BMC' controls style='display:none'>
        <source src='SoundEffect/BMC.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='PONG' controls style='display:none'>
        <source src='SoundEffect/PONG.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='SE00' controls style='display:none'>
        <source src='SoundEffect/SE00.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='SE01' controls style='display:none'>
        <source src='SoundEffect/SE01.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='SE02' controls style='display:none'>
        <source src='SoundEffect/SE02.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='SE03' controls style='display:none'>
        <source src='SoundEffect/SE03.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
    <audio id='SE04' controls style='display:none'>
        <source src='SoundEffect/SE04.m4a' type='audio/mpeg' loop=false>
        Your browser does not support this tag.
    </audio>
  </body>

  <script type='text/javascript'>
    //construction functions
    var Paddle = function(team,x,y,width,height,speed,direction) {
      this.toString = function() {
        return '[object Paddle]';
      };
      this.team = team || 'black';  //in color, marks whom the paddle belongs to
      this.x = x || 512;  //in pixiv, marks the left top corner of the paddle
      this.y = y || 320;  //in pixiv, marks the left top corner of the paddle
      this.width = width || 5;  //in pixiv
      this.height = height || 80; //in pixiv
      this.speed = speed || 60; //in pixiv per second
      this.direction = direction || 'stop';
      this.reset = function(team,x,y,width,height,speed,direction) {
        this.y = y || 320;  //in pixiv, marks the left top corner of the paddle
        this.width = width || 5;  //in pixiv
        this.height = height || 80; //in pixiv
        this.speed = speed || 60; //in pixiv per second
        this.direction = 'stop';
      }
      console.log('Object: ' + this + ' Function: construction Action: new paddle created');
    };
    var Ball = function(direction,team,radius,x,y,speed,worth) {
      this.direction = direction;
      this.x = x || 512;  //in pixiv, marks the center of the ball
      this.y = y || 360;  //in pixiv, marks the center of the ball
      this.radius = radius || 10; //in pixiv
      this.speed = speed || 30; //in pixiv per second
      this.team = team || 'black';
      this.worth = worth || 1;
      this.setSpeed = function(speed) {
        this.speed = speed || 0;
        console.log('Object: ' + this + ' Function: setSpeed Action: ball\'s speed set to ' + this.speed);
      };
      this.toString = function() {
        return '[object Ball]';
      };
      this.reset = function(direction,team,radius,x,y,speed,worth) {
        this.direction = Math.random()*2*Math.PI;
        this.x = x || 512;  //in pixiv, marks the center of the ball
        this.y = y || 360;  //in pixiv, marks the center of the ball
        this.radius = radius || 10; //in pixiv
        this.speed = speed || 30; //in pixiv per second
        this.team = team || 'black';
        this.worth = worth || 1;
      };
      console.log('Object: ' + this + ' Function: construction Action: new ball created');
    };
    var Player = function(color,side,position,score) {
      this.team = color;  //set the color of the team
      this.score = score || 0; //set the score of the team
      this.toString = function() {
        return '[object Player]';
      };
      this.printTeam = function() {
        return 'Player ' + this.team;
      };
      if (side == 'left') {
        this.paddle = new Paddle(color,128,position); //set the paddle of the team
        console.log('Object: ' + this + ' Function: construction Action: new player created on the left side at y = ' + this.position || 360);
      } else if(side == 'right') {
        this.paddle = new Paddle(color,876,position); //set the paddle of the team
        console.log('Object: ' + this + ' Function: construction Action: new player created on the right side at y = ' + this.position || 360);
      } else {
        console.log('ERROR: Object: ' + this + ' Function: construction Reason: invalid side input');
      }
      this.goal = function(scores) {
        this.score += scores || 1;
      }
      this.reset = function(color,side,position,score) {
        this.team = color;  //set the color of the team
        this.score = score || 0; //set the score of the team
        if (side == 'left') {
          this.paddle = new Paddle(color,128,position); //set the paddle of the team
          console.log('Object: ' + this + ' Function: construction Action: new player created on the left side at y = ' + this.position || 360);
        } else if(side == 'right') {
          this.paddle = new Paddle(color,876,position); //set the paddle of the team
          console.log('Object: ' + this + ' Function: construction Action: new player created on the right side at y = ' + this.position || 360);
        } else {
          console.log('ERROR: Object: ' + this + ' Function: construction Reason: invalid side input');
        };
      };
    };
    var features = function() {
      var rand = Math.round(Math.random()*5 - 0.5);
      switch(rand) {
        case 0:
          ball.forEach(function(ball_this) {ball_this.radius /= 1.5;});
          specialEvent.SE00.play();
          break;
        case 1:
          ball.forEach(function(ball_this) {ball_this.speed *= 2;});
          specialEvent.SE01.play();
          break;
        case 2:
          player_L.paddle.height /= 1.5
          player_R.paddle.height /= 1.5
          specialEvent.SE02.play();
          break;
        case 3:
          ball.forEach(function(ball_this) {ball_this.direction = Math.random()*2*Math.PI;});
          specialEvent.SE03.play();
          break;
        case 4:
          ball.forEach(function(ball_this) {ball_this.worth += 1;});
          specialEvent.SE04.play();
          break;
      };
    };
    //initialize
    var stat=['menu'];
    var player_L = {};
    var player_R = {};
    var ball = [{}];
    var cheat = false;
    var botOn = false;
    var pressedM = -1;
    var GUI = document.getElementById('screen');  //relates to the canvas in the HTML document
    var plane = GUI.getContext('2d');
    window.addEventListener('keydown', function(e) {
      if (e.KeyCode == 87 || e.which == 87){  // On Press W
            player_L.paddle.direction = 'up';
        };
        if (e.KeyCode == 83 || e.which == 83){  // On Press S
            player_L.paddle.direction = 'down';
        };
        if ((e.KeyCode == 38 || e.which == 38) && (!botOn)) { // On Press UP
            player_R.paddle.direction = 'up';
        };
        if ((e.KeyCode == 40 || e.which == 40) && (!botOn)) { // On Press DOWN
            player_R.paddle.direction = 'down';
        };
        if (e.KeyCode == 32 || e.which == 32){  // On Press Spacebar
            if (stat[2]=='run') {
              stat[2] = 'pause';
              soundEffect.gamePause.play();
            } else if (stat[2]=='pause' || stat[2]=='win') {
              stat[2] = 'run';
              soundEffect.gameResume.play();
            };
        };
        if (e.KeyCode == 66 || e.which == 66) { // On Press B
          //triger bot
          if (botOn) {
            botOn = false;
            soundEffect.botRemove.play();
          } else {
            botOn = true;
            soundEffect.botAdd.play();
          }
          //reset round
          ball[0].reset();
        player_L.paddle.reset();
        player_R.paddle.reset();
        roundLimit = 8000;
        bonus = 0;
        stat[2]='pause';
        };
        if (e.KeyCode == 82 || e.which == 82) { // On Press R
          //reset round
          ball[0].reset();
        player_L.paddle.reset();
        player_R.paddle.reset();
        roundLimit = 8000;
        bonus = 0;
        stat[2]='pause';
        soundEffect.tie.play();
        };
         if (e.KeyCode == 77 || e.which == 77) {  // On Press M
          if (backgroundMusic.paused) {
            backgroundMusic.play();
            soundEffect.backgroundMusicResume.play();
          } else {
            backgroundMusic.pause();
            soundEffect.backgroundMusicPause.play();
          };
        };
        if (e.KeyCode == 78 || e.which == 78) { // On Press N
          backgroundMusic.pause();
          if (currentSong < backgroundMusicList.length - 1) {
            currentSong ++;
          } else {
            currentSong = 0;
          }
          backgroundMusic.src = 'BGM/' + backgroundMusicList[currentSong];
          soundEffect.backgroundMusicChange.play();
          backgroundMusic.play();
        };
        if (e.KeyCode == 67 || e.which == 67) { // On Press C
          if (cheat) {
            cheat = false;
          } else {
            cheat = true;
          };
        };
    });
    window.addEventListener('keyup', function(e) {
      if (e.KeyCode == 87 || e.which == 87 || e.KeyCode == 83 || e.which == 83) {
        player_L.paddle.direction = 'stop';
      } else if (e.KeyCode == 38 || e.which == 38 || e.KeyCode == 40 || e.which == 40) {
            player_R.paddle.direction = 'stop';
        }
    });
    //window.addEventListener('keypress', function(e) {
      
    //});

    //animation
    window.requestAnimFrame = (function(callback) {
        return window.requestAnimationFrame || window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || 
          function(callback) {
            window.setTimeout(callback, 10);
          };
        })();
      var date = new Date();
      var time = date.getTime();
      var preTime = time;
      var winner;
      var roundLimit = 8000;
      var bonus = 0;
      var backgroundMusic = document.getElementById('BGM');
      var backgroundMusicList = ['PON_PON_PON.mp3','Renai_Circulation.mp3','Alice.mp3','To_The_Limit.mp3','Dango_Daikazoku.mp3','Toki_Wo_Kizamu_Uta.mp3','Decent_Black.mp3','My_Soul_Your_Beats.mp3','Tabi_No_Owari.mp3','Theme_Of_SSS.mp3','This_Game.mp3'];
      var currentSong = 0;
      var soundEffect = {
        redWinRound : document.getElementById('RWR'),
        redWinGame : document.getElementById('RWG'),
        blueWinRound : document.getElementById('BWR'),
        blueWinGame : document.getElementById('BWG'),
        timeUp : document.getElementById('TU'),
        tie : document.getElementById('T'), 
        gameStart : document.getElementById('GS'),
        gamePause : document.getElementById('GP'),
        gameResume : document.getElementById('GR'),
        botAdd : document.getElementById('BA'),
        botRemove : document.getElementById('BR'),
        backgroundMusicPause : document.getElementById('BMP'),
        backgroundMusicResume : document.getElementById('BMR'),
        backgroundMusicChange : document.getElementById('BMC'),
        pong : document.getElementById('PONG')
      };
      var specialEvent = {
        SE00 : document.getElementById('SE00'),
        SE01 : document.getElementById('SE01'),
        SE02 : document.getElementById('SE02'),
        SE03 : document.getElementById('SE03'),
        SE04 : document.getElementById('SE04')
      };
    backgroundMusic.addEventListener('ended', function() {
        backgroundMusic.pause();
        if (currentSong < backgroundMusicList.length - 1) {
          currentSong ++;
        } else {
          currentSong = 0;
        };
        backgroundMusic.src = 'BGM/' + backgroundMusicList[currentSong];
        backgroundMusic.play();
      })
      backgroundMusic.volume = 1/10;
      function bonusTime() {
        ball[0].direction = Math.PI/5;
      };
      function unlimitedRoundTime() {
        roundLimit = 1/0;
      };
      for (var effect in soundEffect) {
        effect.volume = 1/Math.sqrt(10);
      };
      function omitCharacter(inputString) {
        for (i = inputString.length-1; i >= 0; i --) {
          if (inputString[i] == '3' && inputString[i-1] == 'p' && inputString[i-2] == 'm' && inputString[i-3] == '.') {
            inputString = inputString.slice(0, i-3) + inputString.slice(i+1,inputString.length); 
          } else if (inputString[i] == '_') {
            inputString = inputString.slice(0, i) + ' ' + inputString.slice(i+1,inputString.length); 
          };
        };
        return inputString;
      };
    //active to repaint/refresh the canvas
    function refresh() {
      var date = new Date();
          var time = date.getTime();
          var timeDiff = time - preTime;
          preTime = time;
      plane.fillStyle = 'White';
      plane.fillRect(0,0,GUI.width, GUI.height);
      plane.textAlign = 'left';
      plane.font = '16px Comic Sans MS';
      plane.fillStyle = 'Black';
      plane.fillText('Current Background Music: ' + omitCharacter(backgroundMusicList[currentSong]),640,688);
      plane.fillText('Current Play Time: ' + backgroundMusic.currentTime.toFixed(2) + ' / '+ backgroundMusic.duration.toFixed(2) ,640,704);
      plane.textAlign = 'center';
        plane.strokeStyle = 'Black';
        plane.lineWidth=10;
        plane.strokeRect(0,0,GUI.width,GUI.height);
        plane.lineWidth=4;
        plane.font = '128px Comic Sans MS';
        plane.textAlign = 'center';
        plane.fillStyle = 'Red';
        plane.fillText('P', GUI.width*3/9, GUI.height/6);
        plane.fillStyle = 'Black';
        plane.fillText('O', GUI.width*4/9, GUI.height/6);
        plane.fillStyle = 'Green';
        plane.fillText('N', GUI.width*5/9, GUI.height/6);
        plane.fillStyle = 'Blue';
        plane.fillText('G', GUI.width*6/9, GUI.height/6);
      if (stat[0] == 'game') {
        if (stat[1] == 'classic') {
          if (roundLimit <= 0) {
                features();
            roundLimit = 8000;
              };
          //draw the countdown
          plane.strokeStyle = 'Black';
          plane.font = '32px Comic Sans MS';
          plane.fillStyle = 'Black';
          plane.lineWidth=5;
          plane.fillText((roundLimit/1000).toFixed(2) + ' sec left for next special event',512,192);
          //draw the left player's paddle and scores
            plane.font = '96px Comic Sans MS';
          plane.fillStyle = player_L.team;
          plane.fillText(player_L.score,192,128);
          plane.fillRect(player_L.paddle.x,player_L.paddle.y,player_L.paddle.width,player_L.paddle.height);
          //draw the right player's paddle and scores
          plane.fillStyle = player_R.team;
          plane.fillText(player_R.score,832,128);
          plane.fillRect(player_R.paddle.x,player_R.paddle.y,player_R.paddle.width,player_R.paddle.height);
          //draw the ball
          plane.fillStyle = ball[0].team;
          plane.beginPath();
          plane.arc(ball[0].x,ball[0].y,ball[0].radius,0,2*Math.PI,false);
          plane.closePath();
          plane.fill();
              if (cheat) {
                plane.lineWidth = 5;
            plane.strokeStyle = 'Yellow';
                plane.setLineDash([5, 25]);
                plane.beginPath();
            plane.moveTo(ball[0].x,ball[0].y);
            plane.lineTo(ball[0].x + ball[0].speed*Math.cos(ball[0].direction)*timeDiff,ball[0].y + ball[0].speed*Math.sin(ball[0].direction)*timeDiff);
            plane.closePath();
            plane.stroke();
            plane.setLineDash([]);
            plane.strokeStyle = 'Black';
              };
          if (botOn) {
            plane.font = '48px Comic Sans MS';
            plane.fillStyle = player_R.team;
            plane.fillText('BOT',832,44);
          };
          if (stat[2] == 'win') {
            alert(winner.printTeam() + ' wins the game!');
            player_L.reset('blue','left');
            player_R.reset('red','right');
            stat[2] = 'pause';
            soundEffect.gameStart.play();
            plane.font = '72px Comic Sans MS';
            plane.fillStyle = 'Black';
            plane.fillText('Game Over.',512,592);
          } else if (stat[2] == 'pause') {
            plane.fillStyle = 'White';
            plane.fillRect(464,270,96,120);
            plane.lineWidth=4;
            plane.beginPath();
            plane.moveTo(400,270);
            plane.lineTo(400,450);
            plane.moveTo(624,270);
            plane.lineTo(624,450);
            plane.moveTo(430,240);
            plane.lineTo(594,240);
            plane.moveTo(430,480);
            plane.lineTo(594,480);
            plane.stroke();
            plane.beginPath();
            plane.arc(594, 450, 30 , 0, Math.PI/2, false);
            plane.stroke();
            plane.beginPath();
            plane.arc(430, 450, 30 , Math.PI/2, Math.PI, false);
            plane.stroke();
            plane.beginPath();
            plane.arc(430, 270, 30 , Math.PI, Math.PI*3/2, false);
            plane.stroke();
            plane.beginPath();
            plane.arc(594, 270, 30 , Math.PI*3/2, Math.PI*2, false);
            plane.stroke();
            plane.lineWidth=32;
            plane.fillStyle = 'Black';
            plane.beginPath();
            plane.moveTo(480,280);
            plane.lineTo(480,400);
            plane.moveTo(544,280);
            plane.lineTo(544,400);
            plane.font = '32px Comic Sans MS';
            plane.fillText('Game Paused',512,440);
            plane.stroke();
            /*plane.font = '32px Comic Sans MS';
            plane.strokeStyle = 'Yellow';
            plane.setLineDash([5, 15]);
            plane.beginPath();
            plane.moveTo(1024/3,0);
            plane.lineTo(1024/3,720);
            plane.moveTo(2048/3,0);
            plane.lineTo(2048/3,720);
            plane.moveTo(0,360);
            plane.lineTo(1024,360);
            plane.closePath();*/
          } else if (stat[2] == 'run') {
            if (botOn) {
            if (ball[0].x > 512) {
              if (ball[0].y + ball[0].radius - player_R.paddle.y < 0 || ball[0].y - ball[0].radius - player_R.paddle.y - player_R.paddle.height > 0) {
                if (ball[0].y + ball[0].radius < player_R.paddle.y + player_R.paddle.height/10) {
                  player_R.paddle.direction = 'up';
                } else if (ball[0].y - ball[0].radius > player_R.paddle.y + player_R.paddle.height - player_R.paddle.height/10) {
                  player_R.paddle.direction = 'down';
                };
              };
              if ((ball[0].y > player_R.paddle.y + player_R.paddle.height/4) && (ball[0].y < player_R.paddle.y + player_R.paddle.height*3/4)) {
                player_R.paddle.direction = 'stop';
              };
            } else {
              if (player_R.paddle.y + player_R.paddle.height/2 > 360) {
                player_R.paddle.direction = 'up';
              } else if (player_R.paddle.y + player_R.paddle.height/2 < 360) {
                player_R.paddle.direction = 'down';
              } else {
                player_R.paddle.direction = 'stop';
              };
            };
            };
            plane.font = (Math.sqrt(bonus+1) * 24) +'px Comic Sans MS';
            if (bonus <= 39) {
              plane.fillText('Bonus* '+bonus,512,360);
            } else {
              plane.fillText('Max Bonus',512,360);
            };
            roundLimit -= timeDiff;
            //update the ball status
            ball[0].x += ball[0].speed*Math.cos(ball[0].direction)*timeDiff/100;
            ball[0].y += ball[0].speed*Math.sin(ball[0].direction)*timeDiff/100;
            //edge collision
            if (ball[0].x+ball[0].radius-1024 >= 0) {
              player_L.goal(ball[0].worth);
              ball[0].reset();
              player_L.paddle.reset();
              player_R.paddle.reset();
              roundLimit = 8000;
              bonus = 0;
              stat[2]='pause';
              soundEffect.blueWinRound.play();
            } else if (ball[0].x-ball[0].radius <= 0) {
              player_R.goal(ball[0].worth);
              ball[0].reset();
              player_L.paddle.reset();
              player_R.paddle.reset();
              roundLimit = 8000;
              bonus = 0;
              stat[2]='pause';
              soundEffect.redWinRound.play();
            };
            if (player_L.paddle.direction == 'up') {
              player_L.paddle.y -= player_L.paddle.speed*timeDiff/100;
            } else if (player_L.paddle.direction == 'down') {
              player_L.paddle.y += player_L.paddle.speed*timeDiff/100;
            };
            if (player_L.paddle.y <= 0) {
              player_L.paddle.y = 0;
              player_L.paddle.direction = 'stop';
            } else if (player_L.paddle.y >= 720 - player_L.paddle.height) {
              player_L.paddle.y = 720 - player_R.paddle.height;
              player_L.paddle.direction = 'stop';
            };
            if (player_R.paddle.direction == 'up') {
              if (player_R.paddle.direction == 'up') {
                player_R.paddle.y -= player_R.paddle.speed*timeDiff/100;
              } else if (player_R.paddle.direction == 'down') {
                player_R.paddle.y += player_R.paddle.speed*timeDiff/100;
              };
              player_R.paddle.y -= player_R.paddle.speed*timeDiff/100;
            } else if (player_R.paddle.direction == 'down') {
              player_R.paddle.y += player_R.paddle.speed*timeDiff/100;
            };
            if (player_R.paddle.y <= 0) {
              player_R.paddle.y = 0;
              player_R.paddle.direction = 'stop';
            } else if (player_R.paddle.y >= 720 - player_R.paddle.height) {
              player_R.paddle.y = 720 - player_R.paddle.height;
              player_R.paddle.direction = 'stop';
            };
            function verticalDistance(ball,paddle) {  //ball's x distance to paddle
              if (ball.y < paddle.y) {
                return Math.sqrt(Math.abs(ball.x - paddle.x - paddle.width/2)**2 + Math.abs(ball.y - paddle.y)**2);
              } else if (ball.y > paddle.y + paddle.height) {
                return Math.sqrt(Math.abs(ball.x - paddle.x - paddle.width/2)**2 + Math.abs(ball.y - paddle.y - paddle.height)**2);
              } else {
                return Math.abs(ball.x - paddle.x - paddle.width/2);
              };
            };
            function horizontalDistance(ball,paddle) {  //ball's y distance to paddle
              if (ball.x < paddle.x) {
                return Math.sqrt(Math.abs(ball.y - paddle.y - paddle.height/2)**2 + Math.abs(ball.x - paddle.x)**2);
              } else if (ball.x > paddle.x + paddle.height) {
                return Math.sqrt(Math.abs(ball.y - paddle.y - paddle.height/2)**2 + Math.abs(ball.x - paddle.x - paddle.width)**2);
              } else {
                return Math.abs(ball.x - paddle.x - paddle.width/2);
              };
            };
            if (ball[0].y + ball[0].radius - player_R.paddle.y >= 0 && ball[0].y - ball[0].radius - player_R.paddle.y - player_R.paddle.height <= 0 && ball[0].x + ball[0].radius - player_R.paddle.x >= 0 && ball[0].x - ball[0].radius - player_R.paddle.x - player_R.paddle.width <=0) {
              if (ball[0].x - player_R.paddle.x - player_R.paddle.width < 0) {
                ball[0].direction = Math.PI - ball[0].direction;
                ball[0].x += ball[0].speed*Math.cos(ball[0].direction)*timeDiff/90;
                ball[0].y += ball[0].speed*Math.sin(ball[0].direction)*timeDiff/90;
                if (bonus <= 39) {
                  ball[0].speed += 2;
                  bonus += 1;
                };
                ball[0].team = player_R.paddle.team;
              }/* else {
                ball[0].direction = - ball[0].direction;
                ball[0].x += ball[0].speed*Math.cos(ball[0].direction)*timeDiff/90;
                ball[0].y += ball[0].speed*Math.sin(ball[0].direction)*timeDiff/90;
                if (bonus <= 39) {
                  ball[0].speed += 2;
                  bonus += 1;
                };
                ball[0].team = player_R.paddle.team;
              };*/
            } else if (ball[0].y + ball[0].radius - player_L.paddle.y >= 0 && ball[0].y - ball[0].radius - player_L.paddle.y - player_L.paddle.height <= 0 && ball[0].x + ball[0].x + ball[0].radius - player_L.paddle.x >= 0 && ball[0].x - ball[0].radius - player_L.paddle.x - player_L.paddle.width <=0) {
              if (ball[0].x - player_L.paddle.x - player_L.paddle.width > 0) {
              //if (verticalDistance(ball[0],player_L.paddle) <= horizontalDistance(ball[0],player_L.paddle)) {
                ball[0].direction = Math.PI - ball[0].direction;
                ball[0].x += ball[0].speed*Math.cos(ball[0].direction)*timeDiff/90;
                ball[0].y += ball[0].speed*Math.sin(ball[0].direction)*timeDiff/90;
                
                
                if (bonus <= 39) {
                  ball[0].speed += 2;
                  bonus += 1;
                };
                ball[0].team = player_L.paddle.team;
              };
            };
            
            if (ball[0].y+ball[0].radius-720 >= 0 || ball[0].y-ball[0].radius <= 0) {
              ball[0].direction = - ball[0].direction;
              ball[0].x += ball[0].speed*Math.cos(ball[0].direction)*timeDiff/90;
              ball[0].y += ball[0].speed*Math.sin(ball[0].direction)*timeDiff/90;
              
              
              if (bonus <= 39) {
                ball[0].speed += 2;
                bonus += 1;
              };
            };
            if (player_L.score - player_R.score >= 11) {
              stat[2]='win';
              winner = player_L;
              soundEffect.blueWinGame.play();
            } else if (player_L.score - player_R.score <= -11) {
              stat[2]='win';
              winner = player_R;
              soundEffect.redWinGame.play();
            };
          };
        };
      } else if (stat[0]='menu') {
        plane.font = '32px Comic Sans MS';
        plane.fillStyle = 'black';
        plane.fillText('Click / Tap on anywhere to begin', GUI.width/2, GUI.height*1/2);
        GUI.addEventListener('click', function menuClick(e){  //  function click
              plane.clearRect(0,0,GUI.width,GUI.height);
              player_L = new Player('blue','left');
              player_R = new Player('red','right');
              ball[0] = new Ball(Math.random()*2*Math.PI);
              stat = ['game','classic','pause'];
              soundEffect.gameStart.play();
              GUI.removeEventListener('click',menuClick);
              GUI.addEventListener('touchstart', function inGameTouchStart(e){  //  function click
                relativeX = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - GUI.offsetLeft;
                relativeY = e.clientY + document.body.scrollTop + document.documentElement.scrollTop - GUI.offsetTop;
                if (relativeX<1024/3) {
                  if (relativeY<player_L.paddle.y) {
                    player_L.paddle.direction = 'up';
                  } else {
                    player_L.paddle.direction = 'down';
                  };
                } else if (relativeX<2048/3) {
                  if (relativeY<360) {
                    if (stat[2]=='run') {
                      stat[2] = 'pause';
                      soundEffect.gamePause.play();
                    } else if (stat[2]=='pause' || stat[2]=='win') {
                      stat[2] = 'run';
                      soundEffect.gameResume.play();
                    };
                  } else {
                    //triger bot
          if (botOn) {
            botOn = false;
            soundEffect.botRemove.play();
          } else {
            botOn = true;
            soundEffect.botAdd.play();
          }
          //reset round
          ball[0].reset();
        player_L.paddle.reset();
        player_R.paddle.reset();
        roundLimit = 8000;
        bonus = 0;
        stat[2]='pause';
                  };
                } else if (!botOn) {
                  if (relativeY<player_R.paddle.y) {
                    player_R.paddle.direction = 'up';
                  } else {
                    player_R.paddle.direction = 'down';
                  };
                };
              });
              GUI.addEventListener('touchmove', function inGameTouchMove(e){  //  function click
                relativeX = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - GUI.offsetLeft;
                relativeY = e.clientY + document.body.scrollTop + document.documentElement.scrollTop - GUI.offsetTop;
                if (relativeX<1024/3) {
                  if (relativeY<player_L.paddle.y) {
                    player_L.paddle.direction = 'up';
                  } else {
                    player_L.paddle.direction = 'down';
                  };
                } else if (relativeX>2048/3 && !botOn) {
                  if (relativeY<player_R.paddle.y) {
                    player_R.paddle.direction = 'up';
                  } else {
                    player_R.paddle.direction = 'down';
                  };
                };
              });
              GUI.addEventListener('touchend', function inGameTouchEnd(e){  //  function click
                relativeX = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft - GUI.offsetLeft;
                relativeY = e.clientY + document.body.scrollTop + document.documentElement.scrollTop - GUI.offsetTop;
                if (relativeX<1024/3) {
                  player_L.paddle.direction = 'stop';
                } else if (relativeX>2048/3 && !botOn) {
                  player_R.paddle.direction = 'stop';
                };
              });
        });
      };
      requestAnimFrame(function() {
        refresh();
      });
    };
    refresh();
  </script>

</html>